name: CI .NET REST API Tests with Ngrok

on:
  push:
    branches: [main]

jobs:
  test-dotnet-api:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------------------------
      # 1Ô∏è‚É£ Setup .NET SDK
      # ------------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 7.0

      # ------------------------------
      # 2Ô∏è‚É£ Restore dependencies
      # ------------------------------
      - name: Restore .NET dependencies
        run: dotnet restore MyApi.sln

      # ------------------------------
      # 3Ô∏è‚É£ Build the API
      # ------------------------------
      - name: Build API
        run: dotnet build MyApi.sln --configuration Release

      # ------------------------------
      # 4Ô∏è‚É£ Run the API on localhost:5001
      # ------------------------------
      - name: Start API
        run: start /b dotnet run --project ./MyApi/MyApi.csproj --urls "http://localhost:5001"
        shell: cmd

      # ------------------------------
      # 5Ô∏è‚É£ Download Ngrok
      # ------------------------------
      - name: Download Ngrok
        run: |
          curl -L -o ngrok.zip https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip
          powershell -Command "Expand-Archive -Path ngrok.zip -DestinationPath ."
        shell: bash

      # ------------------------------
      # 6Ô∏è‚É£ Start Ngrok tunnel
      # ------------------------------
      - name: Start Ngrok tunnel
        run: start /b ngrok.exe http 5001
        shell: cmd

      # ------------------------------
      # 7Ô∏è‚É£ Wait a few seconds for Ngrok to initialize
      # ------------------------------
      - name: Wait for Ngrok
        run: timeout /t 5
        shell: cmd

      # ------------------------------
      # 8Ô∏è‚É£ Get public Ngrok URL
      # ------------------------------
      - name: Get Ngrok URL
        run: |
          $url = (Invoke-RestMethod -Uri http://127.0.0.1:4040/api/tunnels).tunnels[0].public_url
          Write-Output "NGROK_URL=$url" >> $env:GITHUB_ENV
        shell: powershell

      # ------------------------------
      # 9Ô∏è‚É£ Setup Node.js (for Newman)
      # ------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ------------------------------
      # üîü Install Newman
      # ------------------------------
      - name: Install Newman
        run: npm install -g newman

      # ------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Run Postman Collection against Ngrok URL
      # ------------------------------
      - name: Run API Tests
        run: newman run tests/api_collection.json --env-var "baseUrl=${{ env.NGROK_URL }}"
